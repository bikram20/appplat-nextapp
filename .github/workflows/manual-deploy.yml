name: Manage DigitalOcean App
on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'deploy'
        type: choice
        options:
          - deploy
          - delete
          - fetch-ingress
      environment:
        description: 'Environment to use'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  manage-app:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    steps:
      - uses: actions/checkout@v4
      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
      - name: Manage DigitalOcean App
        env:
          DO_APP_ID: ${{ vars.DO_APP_ID }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          APP_SPEC=".do/app.yaml"
          MAX_RETRIES=30
          RETRY_INTERVAL=20

          update_do_app_id() {
            local new_id=$1
            gh variable set DO_APP_ID --body "$new_id"
            echo "Repository variable DO_APP_ID updated to: $new_id"
          }

          deploy_app() {
            if [[ -z "$DO_APP_ID" ]]; then
              echo "Creating new app..."
              NEW_APP_ID=$(doctl apps create --spec $APP_SPEC --format ID --no-header)
              echo "DO_APP_ID=$NEW_APP_ID" >> $GITHUB_ENV
              update_do_app_id $NEW_APP_ID
              echo "New app created with ID: $NEW_APP_ID"
            else
              echo "Updating existing app..."
              doctl apps update $DO_APP_ID --spec $APP_SPEC
            fi
          }

          delete_app() {
            if [[ -n "$DO_APP_ID" ]]; then
              echo "Deleting app with ID: $DO_APP_ID"
              doctl apps delete $DO_APP_ID --force
              echo "App deleted successfully"
              echo "DO_APP_ID=" >> $GITHUB_ENV
              update_do_app_id ""
              echo "DO_APP_ID repository variable cleared"
            else
              echo "No app ID provided. Nothing to delete."
            fi
          }

          fetch_ingress() {
            if [[ -z "$DO_APP_ID" ]]; then
              echo "::error::No DO_APP_ID provided. Cannot fetch ingress."
              exit 1
            fi
            for ((i=1; i<=MAX_RETRIES; i++)); do
              APP_URL=$(doctl apps get $DO_APP_ID --format DefaultIngress --no-header)
              if [[ -n "$APP_URL" && "$APP_URL" != "null" ]]; then
                echo "App is live at: $APP_URL"
                break
              else
                echo "Attempt $i: Ingress not available yet. Retrying in $RETRY_INTERVAL seconds..."
                sleep $RETRY_INTERVAL
              fi
            done

            if [[ -z "$APP_URL" || "$APP_URL" == "null" ]]; then
              echo "::error::Failed to fetch ingress after $MAX_RETRIES attempts."
              exit 1
            fi
          }

          case "${{ github.event.inputs.action }}" in
            deploy)
              deploy_app
              fetch_ingress
              ;;
            delete)
              delete_app
              ;;
            fetch-ingress)
              fetch_ingress
              ;;
            *)
              echo "::error::Invalid action specified"
              exit 1
              ;;
          esac
      - name: Output current DO_APP_ID
        run: echo "Current DO_APP_ID is ${{ vars.DO_APP_ID }}"